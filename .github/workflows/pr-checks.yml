name: Pre-Merge Code Quality Checks

on:
  pull_request:
    branches:
      - "**"

jobs:
  lint-and-analyze:
    name: üìä Prettier & PMD Static Analysis
    runs-on: ubuntu-latest
    container:
      image: jayadeepkumar61/sfdx-cicd-latest:latest
      credentials:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      options: --user root

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Configure Git Safe Directory
      - name: ‚úÖ Configure Git Safe Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      # Fetch git diff changes
      - name: üîç Detect changed files
        id: changes
        run: |
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD || true)
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV

          CHANGED_CODE_FILES=$(echo "$CHANGED_FILES" | grep -E '\.cls$|\.html$|\.js$|\.json$' || true)
          CHANGED_CODE_FILES_CLEAN=$(echo "$CHANGED_CODE_FILES" | tr '\n' ',' | sed 's/,$//')

          CHANGED_APEX_CLASSES=$(echo "$CHANGED_FILES" | grep 'force-app/main/default/classes/.*\.cls$' || true)
          CHANGED_APEX_CLASSES_CLEAN=$(echo "$CHANGED_APEX_CLASSES" | tr '\n' ',' | sed 's/,$//')

          echo "Changed Files Detected:"
          echo "$CHANGED_FILES"
          echo "Changed Code Files Detected:"
          echo "$CHANGED_CODE_FILES"
          echo "CHANGED_CODE_FILES_CLEAN:"
          echo "$CHANGED_CODE_FILES_CLEAN"
          echo "Changed Apex Classes Detected:"
          echo "$CHANGED_APEX_CLASSES"
          echo "CHANGED_APEX_CLASSES_CLEAN:"
          echo "$CHANGED_APEX_CLASSES_CLEAN"

          if [ ! -z "$CHANGED_CODE_FILES_CLEAN" ]; then
            {
              echo "CHANGED_CODE_FILES<<EOF"
              echo "$CHANGED_CODE_FILES_CLEAN"
              echo "EOF"
            } >> $GITHUB_ENV
          fi

          if [ ! -z "$CHANGED_APEX_CLASSES_CLEAN" ]; then
            {
              echo "CHANGED_APEX_CLASSES<<EOF"
              echo "$CHANGED_APEX_CLASSES_CLEAN"
              echo "EOF"
            } >> $GITHUB_ENV
          fi

      # Run Prettier on changed files
      - name: üé® Run Prettier Check on Changed Files
        id: prettier
        continue-on-error: true
        run: |
          if [ -z "$CHANGED_CODE_FILES" ]; then
            echo "‚ö° No relevant files for Prettier."
            exit 0
          fi
          echo "üîç Running Prettier on:"
          echo "$CHANGED_CODE_FILES"
          prettier --plugin=prettier-plugin-apex --check $CHANGED_CODE_FILES

      # Run PMD on changed Apex classes
      - name: üß† Run PMD Static Code Analysis on Changed Apex Classes
        id: pmd
        continue-on-error: true
        run: |
          if [ -z "$CHANGED_APEX_CLASSES" ]; then
            echo "‚ö° No Apex classes changed. Skipping PMD."
            exit 0
          fi
          echo "üîç Running PMD on:"
          echo "$CHANGED_APEX_CLASSES"
          pmd pmd -d force-app/main/default/classes -R rulesets/apex/quickstart.xml -f text

      - name: ‚ùå Fail if Prettier or PMD failed
        run: |
          echo "üß™ Checking previous step results..."
          if [ "${{ steps.prettier.outcome }}" == "failure" ] || [ "${{ steps.pmd.outcome }}" == "failure" ]; then
            echo "‚ùå One or more checks failed."
            exit 1
          else
            echo "‚úÖ All checks passed!"
          fi
