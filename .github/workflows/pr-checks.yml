name: Pre-Merge Code Quality Checks

on:
  pull_request:
    branches:
      - "**"

jobs:
  lint-and-analyze:
    name: ğŸ“Š Prettier & PMD Static Analysis
    runs-on: ubuntu-latest
    container:
      image: jayadeepkumar61/sfdx-cicd-latest:latest
      credentials:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      options: --user root

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Configure Git Safe Directory
      - name: âœ… Configure Git Safe Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      # Fetch git diff changes
      - name: ğŸ” Detect changed files
        id: changes
        run: |
          git fetch origin main

          CHANGED_FILES=$(git diff --name-only origin/main...HEAD || true)
          echo "$CHANGED_FILES" | grep -E '\.cls$|\.html$|\.js$|\.json$' > changed_code_files.txt || true
          echo "$CHANGED_FILES" | grep 'force-app/main/default/classes/.*\.cls$' > changed_apex_classes.txt || true

          echo "Changed Code Files:"
          cat changed_code_files.txt || true
          echo "Changed Apex Classes:"
          cat changed_apex_classes.txt || true

      # Run Prettier on changed files
      - name: ğŸ¨ Run Prettier Check on Changed Files
        id: prettier
        continue-on-error: true
        run: |
          if [ ! -s changed_code_files.txt ]; then
            echo "âš¡ No files to lint."
            exit 0
          fi
          echo "ğŸ” Running Prettier on:"
          cat changed_code_files.txt
          prettier --plugin=prettier-plugin-apex --check $(cat changed_code_files.txt)

      # Run PMD on changed Apex classes
      - name: ğŸ§  Run PMD Static Code Analysis on Changed Apex Classes
        id: pmd
        continue-on-error: true
        run: |
          if [ ! -s changed_apex_classes.txt ]; then
            echo "âš¡ No Apex classes changed. Skipping PMD."
            exit 0
          fi
          echo "ğŸ” Running PMD on Apex Classes:"
          cat changed_apex_classes.txt
          for file in $(cat changed_apex_classes.txt); do
            pmd pmd -d $(dirname "$file") -R rulesets/apex/quickstart.xml -f text
          done

      - name: âŒ Fail if Prettier or PMD failed
        run: |
          echo "ğŸ§ª Checking previous step results..."
          if [ "${{ steps.prettier.outcome }}" == "failure" ] || [ "${{ steps.pmd.outcome }}" == "failure" ]; then
            echo "âŒ One or more checks failed."
            exit 1
          else
            echo "âœ… All checks passed!"
          fi
